@page "/"
@rendermode InteractiveServer
@using System.Text.Json
@inject IJSRuntime JSRuntime

<PageTitle>Todo</PageTitle>

<header class="py-4 text-center text-7xl font-bold text-gray-300">
    Todos
</header>

<main class="max-w-2xl mx-auto">
    <section class="mt-6">
        <EditForm Model="@todoModel" OnValidSubmit="@AddTodo"
                  class="flex justify-between gap-6 group transition-all duration-1000 ease-in-out hover:scale-101 items-center w-[80%] mx-auto px-8 py-3 rounded-full shadow-md shadow-gray-400">
            
            <InputText @bind-Value="todoModel.Text" 
              placeholder="Add Todo..." 
              class="w-full outline-none" />

            <button type="submit" class="flex align-middle">
                <span class="bg-green-700 text-white font-bold pb-1 px-2.5 rounded-full text-2xl group-hover:scale-102 transition-all duration-1000 ease-in-out">
                    +
                </span>
            </button>
        </EditForm>
    </section>

    <section class="mt-6 relative">
        <div class='transition-all duration-500 ease-in-out'>
            @if (todos.Count > 0)
            {
                <p class="text-end text-sm text-red-700 font-semibold hover:underline underline-offset-2 cursor-pointer" 
                @onclick="ClearAll">Clear All</p>
            }else{
                <p class='text-gray-400 text-sm text-center'>Add Some Tasks</p>
            }
        </div>
        
        <ul>
            @for (int i = 0; i < todos.Count; i++)
            {
                int index = i;
                <li class="flex justify-between items-center px-4 py-2">
                    <label class="flex items-center gap-2">
                        <input type="checkbox"
                               checked="@checkedItems[index]"
                               disabled="@allChecked"
                               @onchange="() => ToggleChecked(index)"
                               class="accent-green-600 hover:scale-110 transition-all duration-900 ease-in-out" />
                        @if (editingIndex == index)
                        {
                            <input type="text" @bind="editText" @onkeypress="@((e) => HandleKeyPress(e, index))"
                                   class="ml-4 text-lg outline-none border-b-2 border-blue-500 bg-transparent" />
                        }
                        else
                        {
                            <div class="ml-4">
                                <span class="text-lg @(checkedItems[index] ? "line-through" : "")">
                                    @todos[index].Text
                                </span>
                                <div class="text-xs text-gray-500">
                                    @todos[index].CreatedDate.ToString("MMM dd, yyyy")
                                </div>
                            </div>
                        }
                    </label>

                    <div class="flex gap-6">
                        @if (editingIndex == index)
                        {
                            <button class="cursor-pointer" @onclick="() => SaveEdit(index)">
                                <span class="text-green-600 text-sm font-semibold hover:scale-110 transition-all duration-200 ease-in-out">save</span>
                            </button>
                        }
                        else
                        {
                            <button disabled="@allChecked" class="cursor-pointer" @onclick="() => StartEdit(index)">
                                <span class="text-blue-600 text-sm font-semibold hover:scale-110 transition-all duration-200 ease-in-out">edit</span>
                            </button>
                        }
                        <button disabled="@allChecked" class="cursor-pointer" @onclick="() => DeleteTodo(index)">
                            <span class="text-red-700 text-lg font-semibold hover:scale-110 transition-all duration-200 ease-in-out">x</span>
                        </button>
                    </div>
                </li>
            }
        </ul>

        <div class="transition-all duration-500 ease-out transform fixed top-0 left-1/2 -translate-x-1/2 z-50 w-[80%] max-w-md mt-6 px-6 py-4 rounded-2xl text-center shadow-lg @(allChecked ? "bg-white text-black" : "hidden") @(showMessage ? "translate-y-0 opacity-100" : "-translate-y-full opacity-0")">
            <h1 class="text-xl font-bold">Well Done!</h1>
            <p class="text-sm">All tasks have been finished</p>
        </div>
    </section>
</main>

@code {
    private List<TodoItem> todos = new();
    private List<bool> checkedItems = new();
    private int editingIndex = -1;
    private string editText = string.Empty;
    private const string FilePath = "todos.json";

    public class TodoItem
    {
        public string Text { get; set; } = string.Empty;
        public DateTime CreatedDate { get; set; }
        public bool IsCompleted { get; set; }
    }

    public class TodoModel 
    { 
        public string Text { get; set; } = string.Empty; 
    }

    private TodoModel todoModel = new();

    private bool allChecked => checkedItems.Count > 0 && checkedItems.All(c => c);
    private bool showMessage => allChecked;

    private async Task AddTodo()
    {
        if (!string.IsNullOrWhiteSpace(todoModel.Text))
        {
            var newTodo = new TodoItem
            {
                Text = todoModel.Text.Trim(),
                CreatedDate = DateTime.Now,
                IsCompleted = false
            };
            todos.Add(newTodo);
            checkedItems.Add(false);
            todoModel.Text = string.Empty;
            await SaveTodosToFile();
            StateHasChanged();
        }
    }

    private async Task DeleteTodo(int index)
    {
        if (index >= 0 && index < todos.Count)
        {
            todos.RemoveAt(index);
            checkedItems.RemoveAt(index);
            await SaveTodosToFile();
            StateHasChanged();
        }
    }

    private async Task ToggleChecked(int index)
    {
        if (index >= 0 && index < checkedItems.Count)
        {
            checkedItems[index] = !checkedItems[index];
            todos[index].IsCompleted = checkedItems[index];
            await SaveTodosToFile();
            StateHasChanged();
        }
    }

    private async Task ClearAll()
    {
        todos.Clear();
        checkedItems.Clear();
        await SaveTodosToFile();
        StateHasChanged();
    }

    private void StartEdit(int index)
    {
        editingIndex = index;
        editText = todos[index].Text;
        StateHasChanged();
    }

    private async Task SaveEdit(int index)
    {
        if (!string.IsNullOrWhiteSpace(editText))
        {
            todos[index].Text = editText.Trim();
            await SaveTodosToFile();
        }
        editingIndex = -1;
        StateHasChanged();
    }

    private void CancelEdit()
    {
        StateHasChanged();
    }



    private async Task HandleKeyPress(KeyboardEventArgs e, int index)
    {
        if (e.Key == "Enter")
        {
            await SaveEdit(index);
        }
        else if (e.Key == "Escape")
        {
            CancelEdit();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadTodosFromFile();
    }

    private async Task SaveTodosToFile()
    {
        var json = JsonSerializer.Serialize(todos);
        await File.WriteAllTextAsync(FilePath, json);
    }

    private async Task LoadTodosFromFile()
    {
        if (File.Exists(FilePath))
        {
            var json = await File.ReadAllTextAsync(FilePath);
            todos = JsonSerializer.Deserialize<List<TodoItem>>(json) ?? new();
            todos = todos.OrderBy(t => t.CreatedDate).ToList();
            checkedItems = todos.Select(t => t.IsCompleted).ToList();
        }
    }
}